---
title: "Chapter 4"
author: "R Pienaar"
date: "`r Sys.Date()`"
output: pdf_document
---

Load packages

```{r}


library(tidyverse)
library(camtrapR)
library(exiftoolr)



Sys.which("exiftool.exe") ### Where is exiftool?
exiftoolPath("C:/Users/ryanp/Documents/Dissertation/Raw data/Nebo Fire/Camera Base 1.7/Fixes/EXIFTool/exiftoolgui/exiftool.exe")

```



Input data
```{r}

rt = read.csv("C:/Users/ryanp/Documents/Dissertation/Chapter4_Camera traps/Camelot Exports/Record Tables/Final_record_table.csv")
head(rt)

ctt = read.csv("C:/Users/ryanp/Documents/Dissertation/Chapter4_Camera traps/Camelot Exports/Record Tables/Final_camtrap_table.csv")

#df <- df[c(1,4,6,7,8, 15,16)]

camop <- cameraOperation(CTtable = ctt,
                         stationCol = "Station",
                         sessionCol = "Session",
                         setupCol = "Setup_date",
                         retrievalCol = "Retrieval_date",
                         hasProblems = FALSE,             #The cameras were out the whole time, we don't know when the problems happened so I'm just keeping it as no problems
                         dateFormat = "mdy")



```


View data

```{r}

rt <- subset(rt, Species != "Unknown bird")      #remove birds and rabbits
rt <- subset(rt, Species != "Unknown lagomorph")

count_sp <- as.data.frame(table(rt$Species))  # show number of each species
count_sp
names(count_sp) <- c("Species", "N_Obs")

```

```{r}

sp_station <- table(rt$Species,rt$Station)
sp_station


```

Report

```{r}

###### Needs to be done seperately for each session

report <- surveyReport(recordTable = rt,
                       CTtable = ctt,
                       speciesCol = "Species",
                       retrievalCol = "Retrieval_date",
                       setupCol = "Setup_date",
                       CTDateFormat = "mdy",
                       recordDateTimeCol = "DateTimeOriginal",
                       recordDateTimeFormat = "mdy")

```

Detection History

```{r}

deerdh <- detectionHistory( recordTable = rt,
                            camOp = camop,
                            species = "Odocoileus hemionus",
                            stationCol = "Station",
                            speciesCol = "Species",
                            recordDateTimeCol = "Date",
                            recordDateTimeFormat = "mdy",
                            occasionLength = 30,
                            scaleEffort = FALSE,
                            timeZone = "MST",
                            day1 = "survey",
                            unmarkedMultFrameInput = TRUE)

deerdh$detection_history

```

Occupancy analysis

```{r}

library(unmarked)
deerdh <- deerdh$detection_history


Forest <- as.data.frame(substr(rownames(deerdh),5,5))
Fire <- as.data.frame(substr(rownames(deerdh),7,7))

covs <- cbind(Forest, Fire)
colnames(covs) <- c("Forest", "Fire")

deerocc <- unmarkedFrameOccu(y = deerdh, siteCovs = covs)

summary(deerocc)
deerocc

```

Create Models (Single season)

```{r}


rm(deer3)
# Null deer model with constant detection and constant occupancy
d.1.1 <- occu(~1~1, data =  deerocc)  #### detection first, then occupancy
d.1.1

d.1.1.psi <- backTransform(d.1.1, type = "state") #Occupancy
d.1.1.psi

d.1.1.p <- backTransform(d.1.1, type = "det") #Detection
d.1.1.p

d.1.1.psi.ci <- confint(d.1.1.psi)
d.1.1.p.ci <- confint(d.1.1.p)

###Constant detection
d.1.FoFi <- occu(~1 ~ Forest + Fire, data = deerocc)
d.1.FoFi

d.1.Fo <- occu(~1 ~ Forest, data = deerocc)
d.1.Fi <- occu(~1 ~ Fire, data = deerocc)


#Constant occupancy
d.FoFi.1 <- occu(~Forest + Fire ~1, data = deerocc)
d.FoFi.1

d.Fo.1 <- occu(~ Forest ~1, data = deerocc)
d.Fi.1 <- occu(~ Fire ~1, data = deerocc)

# Full model
d.FoFi.FoFi <- occu(~Forest + Fire ~Forest+Fire, data = deerocc)

```

Model Selection with constant occupancy to evaluate detection

```{r}

d.const.occ <- fitList(d.FoFi.1,d.Fo.1, d.Fi.1, d.1.1)
modSel(d.const.occ)

d.FoFi.1
newdata <- expand.grid(Forest = levels(deerocc@siteCovs$Forest), 
                       Fire = levels(deerocc@siteCovs$Fire))

det.mod.pred <- predict(d.FoFi.1, type = "det", newdata = newdata, append = TRUE)
det.mod.pred

```




Create models (multiseason)

```{r}

deer1 <- colext(~1 ~1 ~1 ~1, data = deerocc)

```


